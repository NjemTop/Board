**HappyFox_Bot_tg**

# Описание работы бота с HappyFox

Бот принимает на себя WebHook-и из системы HappyFox, обрабатывает их и выдаёт следующие алерты:

1. пришёл новый тикет (направляется оповещение в общую группу);
2. смена исполнителя в тикете (направляется оповещение персонально в чат исполнителю, исключение, когда сам на себя переводишь)
3. ответ клиента в тикете (направляется оповещение персонально в чат исполнителю);
4. если не было ответа в тикете в течение часа, отправляется повторный алерт персонально в чат исполнителю;
5. если не было ответа в тикете в течение двух часов, отправляется повторный алерт в общую группу;
6. в 10:25 приходит алерт, если есть тикеты, в которых был ответ клиенту 3 и более дней назад, направляется оповещение персонально в чат исполнителю.

Паралельно непрерывно функционирует Web-сервер, который на себя принимает WebHook-и работает по порту 3030.

У бота есть система отправки рассылки клиентам о выходе новой версии, которая выполняет следующие действия:

1. получает доступ к NextCloud, затем смотрит, что лежит в директории "1. Актуальный релиз/Документация" и перемещает найденую папку в директорию "2. Предыдущие релизы/Документация";
2. получает доступ к корпоративному Яндекс.Диску через систему [OAuth-токен](https://oauth.yandex.ru/), затем проходится по всем заданным папкам в `Main.config` файле и временно сохраняет их на локальную машину;
3. так как папка с документацией была перемещена, создаёт новую папку с наименованием версии в директории "1. Актуальный релиз/Документация";
4. загружает все временно загруженные файлы в папку и удаляет файлы с локальной машины;
5. получает информацию о том, что лежит в директории "1. Актуальный релиз/Дистрибутив" и перемещает найденную папку в директорию "2. Предыдущие релизы/Дистрибутив";
6. так как папка с дистрибутивом была перемещена, создаёт новую папку с наименованием версии в директории "1. Актуальный релиз/Дистрибутив";
7. получает доступ к ранее монтированному диску "/windows_share/`номер версии`/Release/Mainstream", затем смотрит, что лежит в данной директории и перемещает на NextCloud;
8. запускается скрипт PowerShell на отправку рассылки клиентам, которые предварительно в филде с названием `Notification update` указаны, как "Да";
9. по завершении скрипта, отправляет в чат сводный отчёт об успешной отправке или об ошибках, а также на почту заданным сотрудникам отправляется общий сводный отчёт об отправке.

## Настройка перед началом

### Монтируем файловую шару к папке

`/mnt/windows_share: sudo mount -t cifs //corp.boardmaps.com/data/Releases/[Server] /mnt/windows_share -o username=NAME,password=PASSWORD,rw,vers=2.1`

### Docker-compose запуск контейнера

`docker-compose up -d`

### Dockerfile: Запускаем контейнер с мапингом логов и прокидыванием порта 3030 на локал машину, а также мапингом файловой шары командой:

`docker run -d --privileged -e TZ=Europe/Moscow --name hf_bot -p 3030:3030 -v $(pwd)/logs:/app/logs -v /mnt/windows_share:/windows_share hf_bot_tg`
